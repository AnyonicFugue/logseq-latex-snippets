var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};const is_debugging=!1,DEFAULT_LOCALE="en";let locale$1="en",translations={},user_settings={};async function setup({defaultLocale:e="en",builtinTranslations:n}){(locale$1=(await logseq.App.getUserConfigs()).preferredLanguage)!==e&&n?.[locale$1]!=null&&(translations=n)}function t(e,n){let a=translations[locale$1]?.[e]??e;return null==n?a:Object.entries(n).reduce((e,[n,a])=>e.replaceAll(`\${${n}}`,a),a)}var zhCN={"Reload user functions":"重新加载用户函数","User defined functions reloaded.":"用户函数已重新加载。"};window.clipboard=async()=>await parent.navigator.clipboard.readText()??"",window.callPlugin=(e,...n)=>(setTimeout(()=>logseq.App.invokeExternalPlugin(e,...n),50),""),window.callCommand=(e,...n)=>(setTimeout(()=>logseq.App.invokeExternalCommand(e,...n),50),"");const TRIGGER_IMMEDIATE=1,TRIGGER_REGEX=4,IN_INLINEMATH=7,IN_DISPLAYMATH=10,NOT_IN_MATH=-1,PairOpenChars="{([",PairCloseChars="})]";let regexRules=[],immediateRules=[];const evaluate=eval;let selectedText="";function init(){let e=parent.document.getElementById("app-container");e.addEventListener("beforeinput",beforeInputHandler),e.addEventListener("input",inputHandler)}function cleanUp(){let e=parent.document.getElementById("app-container");e.removeEventListener("input",inputHandler),e.removeEventListener("beforeinput",beforeInputHandler)}async function getUserRules(){var e;let n=await fetch("./snippets.json");if(!n.ok)return console.error("HTTP-Error: ",n.status),[];e=await n.json();let a=[];for(let l of Object.keys(e)){for(let i=0;i<e[l].length;i++){let s=e[l][i];user_settings.caseInsensitive?a.push({trigger:RegExp(`${s.match}$`,"i"),repl:s.replacement}):a.push({trigger:RegExp(`${s.match}$`),repl:s.replacement})}console.log(`Group ${l} loaded`)}return a}async function reloadUserRules(){let e=await getUserRules();e.length>0&&(regexRules=[...e])}function getChar(e){switch(e){case"“":return"”";case"‘":return"’";default:return e}}function getOpenPosition(e){switch(e){case"”":return"{([".indexOf("“");case"’":return"{([".indexOf("‘");default:return"{([".indexOf(e)}}function getBlockUUID(e){return e.id.replace(/^edit-block-[0-9]+-/,"")}function findBarPos(e){for(let n=e.length-1;n>=0;n--)if("@"===e[n])return n-1;return -1}function isInLatex(e){let n=/\$\$/gm,a=e.match(n);if(a&&a.length%2==1)return 10;e=(e=e.replaceAll(n,"")).replaceAll(/\$(?![\s])([\s\S]+?)(?<![\s])\$/gm,"");let l=e.match(/\$(?![\s])[\s\S]+$/);return l?7:-1}async function inputHandler(e){if(null==e.data||"TEXTAREA"!==e.target.nodeName||!e.target.parentElement.classList.contains("block-editor")||e.isComposing)return;let n=e.target;await handleRules(n,e)||await handleSpecialKeys(n,e)}async function beforeInputHandler(e){if(null==e.data||"TEXTAREA"!==e.target.nodeName||!e.target.parentElement.classList.contains("block-editor")||e.isComposing)return;let n=e.target;selectedText=n.value.substring(n.selectionStart,n.selectionEnd)}async function handleRules(e,n){let a=n.data[n.data.length-1],l=e.value.substring(0,e.selectionStart),i=isInLatex(l);if(-1===i)return!1;if(" "===a)for(let{trigger:s,repl:r}of regexRules){let o=e.value.substring(0,e.selectionStart-1).lastIndexOf("$"),c=e.value.substring(o,e.selectionStart-1),u=c.match(s);if(null!=u){let d=u.index+u[0].length,p=c.substring(u.index,d).replace(s,r),g=findBarPos(p),f=p.replace("@","");!user_settings.DeleteBlankAfterMatchInline&7===i&&" "!==f.slice(-1)&&g==f.length-1&&(f=f.concat(" "),g+=1),!user_settings.DeleteBlankAfterMatchDisplay&10===i&&" "!==f.slice(-1)&&g==f.length-1&&(f=f.concat(" "),g+=1),f=f.concat(c.substring(d));let h=g<0?0:g-f.length-(e.value.length-e.selectionStart)+1,_=getBlockUUID(n.target);return await updateText(e,_,f+e.value.substring(e.selectionStart),-(c.length-u.index+1),0,h),!0}}for(let{trigger:m,repl:y}of immediateRules)return!1}async function handleSpecialKeys(e,n){if(n.data.length>1)return!1;let a=getChar(n.data[0]);getOpenPosition(a);let l=e.value,i=l[e.selectionStart],s=l[e.selectionStart-2],r=l.substring(0,e.selectionStart);if("$"===a){let o=getBlockUUID(n.target);if(-1===isInLatex(r)&&"$"===i){let c="".concat(l.substring(e.selectionStart));return await updateText(e,o,c,-1,1,-c.length+1),!0}if("$"===i&&"$"===s&&user_settings.newLineForDisplayMath&&e.selectionStart===e.selectionEnd){if(2==e.selectionStart){let u="$$\n\n$".concat(l.substring(e.selectionStart));return await updateText(e,o,u,-2,2,-u.length+3),!0}if("\n"!==l[e.selectionStart-3]){let d="\n$$\n\n$".concat(l.substring(e.selectionStart));return await updateText(e,o,d,-2,2,-d.length+4),!0}{let p="$$\n\n$".concat(l.substring(e.selectionStart));return await updateText(e,o,p,-2,2,-p.length+3),!0}}if(user_settings.wrapwithDollarBracket){let g=selectedText,f=g.trimStart(),h=f.trimEnd(),_=(g!==f?" $":"$")+h+(f!==h?"$ ":"$")+l.substring(e.selectionStart);cursor_offset=-(l.length-e.selectionStart),0==selectedText.length&&(cursor_offset-=1),await updateText(e,o,_,-1,1,cursor_offset)}else{let m="$$"+l.substring(e.selectionStart);await updateText(e,o,m,-1,1,-m.length+1)}return!0}if(user_settings.VerticalLineBracket&&"|"===a&&"\\"!==s&&-1!==isInLatex(r)){let y=getBlockUUID(n.target);if("|"===i){let b="".concat(l.substring(e.selectionStart));return await updateText(e,y,b,-1,1,-b.length+1),!0}if(""!==selectedText){let x=selectedText,w=x.trimStart(),E=w.trimEnd(),S="|"+E+"|"+l.substring(e.selectionStart);await updateText(e,y,S,-1,1,-S.length+1)}return!0}if("("===a){let $=getBlockUUID(n.target),T="()".concat(l.substring(e.selectionStart));return await updateText(e,$,T,-1,1,-T.length+1),!0}return!1}async function updateText(e,n,a,l=0,i=0,s=0,r=1){let o=e.selectionStart===e.selectionEnd,c=e.selectionStart+l,u=(e.selectionEnd,c+a.length+s),d=e.value;try{await logseq.Editor.updateBlock(n,c<d.length?`${d.substring(0,c)}${a}`:c===d.length?`${d}${a}`:`${d} ${a}`)}catch(p){reject(p)}e.focus(),null!=s&&e.setSelectionRange(o?u:c+r,o?u:u-r)}async function main(){await setup({builtinTranslations:{"zh-CN":zhCN}}),init(),user_settings=logseq.useSettingsSchema([{key:"wrapwithDollarBracket",type:"boolean",default:!0,description:t("Enable: Wrap selected text with dollars, when dollar is typed.")},{key:"caseInsensitive",type:"boolean",default:!0,description:t("Enable: Matching is case-insensitve.")},{key:"VerticalLineBracket",type:"boolean",default:!1,description:t('Enable: In latex environment, wrap selected text with vertical line "|", when it is typed.')},{key:"DeleteBlankAfterMatchInline",type:"boolean",default:!0,description:t("Enable: Delete the typed blank space in inline math after matching")},{key:"DeleteBlankAfterMatchDisplay",type:"boolean",default:!1,description:t("Enable: Delete the typed blank space in display math after matching")},{key:"newLineForDisplayMath",type:"boolean",default:!0,description:t("Enable: Automatically add a new line after typing $$$$.")}]).settings;let e=logseq.onSettingsChanged(reloadUserRules);logseq.App.registerCommandPalette({key:"reload-latex-snippets",label:t("Reload snippets from the snippets.json")},async()=>{await reloadUserRules(),await logseq.UI.showMsg(t("Latex snippets reloaded."))}),logseq.App.registerCommandPalette({key:"open-snippets.json",label:t("Open the config file for snippets in external editor")},async()=>{window.open("snippets.json")}),logseq.Editor.registerSlashCommand("reload latex snippets",async()=>{await reloadUserRules(),await logseq.UI.showMsg(t("Latex snippets reloaded."))}),logseq.Editor.registerSlashCommand("open snippets.json",async()=>{window.open("snippets.json")}),logseq.beforeunload(()=>{e(),cleanUp()}),console.log("#smart-typing loaded")}logseq.ready(main).catch(console.error);

